<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digipen Hangout Pomodoro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            overflow: hidden;
            background-color: #2c1a13;
        }

        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #3d251a;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .interior-wall {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #2c1a13 0%, #3d251a 100%);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }

        .wall-decoration {
            position: absolute;
            top: 2%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            z-index: 2;
            white-space: nowrap;
            animation: floatText 3s ease-in-out infinite;
            letter-spacing: -2px;
            text-shadow: 4px 4px 0 #000;
        }

        @media (max-height: 800px) {
            .wall-decoration {
                font-size: 24px;
                top: 1%;
            }
        }
        @keyframes floatText {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }
        .letter-red { color: #ef4444; }
        .letter-green { color: #22c55e; }

        .fireplace {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 240px;
            height: 200px;
            background: #4a2c20;
            border: 6px solid #6b422e;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            z-index: 5;
        }
        .fireplace-mantel {
            width: 260px;
            height: 25px;
            background: #6b422e;
            border-bottom: 5px solid #3d251a;
            position: absolute;
            top: -30px;
            left: -16px;
        }
        .fire-pit {
            width: 180px;
            height: 140px;
            background: #000;
            margin-top: 35px;
            position: relative;
            overflow: hidden;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .fire {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 90px;
            background: linear-gradient(to top, #ff0000, #ff4500, #ffeb3b);
            border-radius: 50% 50% 20% 20%;
            animation: flicker 0.5s infinite alternate;
        }
        @keyframes flicker {
            from { transform: translateX(-50%) scale(1); opacity: 1; }
            to { transform: translateX(-50%) scale(0.95) translateY(5px); opacity: 0.8; }
        }

        .window-frame {
            position: absolute;
            top: 15%;
            left: 5%;
            width: 320px;
            height: 420px;
            background: #6b422e;
            border: 12px solid #4a2c20;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 5px 5px 15px rgba(0,0,0,0.3);
            z-index: 2;
        }
        .window-glass {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #0f172a 0%, #1e293b 100%);
            position: relative;
            overflow: hidden;
        }
        .mountain {
            position: absolute;
            bottom: 0;
            width: 0;
            height: 0;
            border-left: 150px solid transparent;
            border-right: 150px solid transparent;
            border-bottom: 300px solid #1e293b;
            z-index: 1;
        }
        .mountain::after {
            content: '';
            position: absolute;
            top: 20px;
            left: -150px;
            width: 0;
            height: 0;
            border-left: 150px solid transparent;
            border-right: 150px solid transparent;
            border-bottom: 120px solid rgba(255, 255, 255, 0.05); 
        }
        #snow-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .christmas-tree {
            position: absolute;
            bottom: 8%;
            right: 10%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.6));
        }
        .tree-star {
            width: 40px;
            height: 40px;
            background: #fbbf24;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            margin-bottom: -10px;
            z-index: 20;
            animation: starShine 1.5s infinite alternate;
            box-shadow: 0 0 20px #fbbf24;
        }
        .tree-layer {
            width: 0;
            height: 0;
            border-left: solid transparent;
            border-right: solid transparent;
            border-bottom: solid #15803d;
            position: relative;
            margin-top: -15px;
        }
        .tree-layer:first-of-type {
            margin-top: 0;
        }
        .tree-trunk {
            width: 30px;
            height: 40px;
            background: #5d3a1a;
            margin-top: -10px;
            box-shadow: inset 2px 0 5px rgba(0,0,0,0.5);
        }
        .tree-light {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            animation: twinkle 1.2s infinite alternate;
            box-shadow: 0 0 8px currentColor;
        }
        @keyframes starShine {
            from { transform: scale(0.9); filter: brightness(1); }
            to { transform: scale(1.1); filter: brightness(1.3); }
        }
        @keyframes twinkle {
            from { opacity: 0.4; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1.1); }
        }

        #ui-container {
            position: relative;
            z-index: 100;
            backdrop-filter: blur(8px);
            background: rgba(40, 20, 10, 0.85);
            border: 4px solid #5d3a2a;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
            max-width: 550px;
            margin: 0 auto;
            transform: scale(0.85);
            transform-origin: center;
        }

        @media (min-height: 900px) {
            #ui-container {
                transform: scale(1);
                max-width: 600px;
            }
        }

        .retro-button {
            transition: all 0.1s;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
        }
        .retro-button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0,0,0,0);
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .mode-badge {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .toggle-ui-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 110;
            background: rgba(107, 66, 46, 0.8); 
            color: white;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            backdrop-filter: blur(2px);
            border: 2px solid rgba(255,255,255,0.4);
            font-size: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* ÎÆ§Ìä∏ & ÏßëÏ§ë Î™®Îìú Î≤ÑÌäº */
        .mode-buttons {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 110;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mode-btn {
            background: rgba(107, 66, 46, 0.9);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(2px);
            border: 2px solid rgba(255,255,255,0.4);
            font-size: 11px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-btn:hover {
            background: rgba(107, 66, 46, 1);
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: #22c55e;
            border-color: #166534;
        }

        .mode-btn.muted {
            background: #ef4444;
            border-color: #991b1b;
        }
        
        /* URL Í≥µÏú† Î™®Îã¨ */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .share-modal.active {
            display: flex;
        }
        
        .share-content {
            background: rgba(40, 20, 10, 0.95);
            border: 4px solid #fbbf24;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }
        
        .share-title {
            font-size: 16px;
            color: #fbbf24;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #000;
        }
        
        .share-option {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #78350f;
        }
        
        .share-option-title {
            font-size: 10px;
            color: #fbbf24;
            margin-bottom: 8px;
        }
        
        .share-url-box {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 6px;
            border: 2px solid #fbbf24;
            font-size: 9px;
            color: #fff;
            word-break: break-all;
            margin-bottom: 8px;
            max-height: 60px;
            overflow-y: auto;
        }
        
        .share-button {
            background: #22c55e;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
            border: none;
            box-shadow: 0 3px 0 #166534;
            transition: all 0.1s;
            width: 100%;
        }
        
        .share-button:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #166534;
        }
        
        .share-button.copied {
            background: #3b82f6;
            box-shadow: 0 3px 0 #1e40af;
        }
        
        .share-close {
            background: #ef4444;
            margin-top: 15px;
            box-shadow: 0 3px 0 #991b1b;
        }
        
        .share-time-input {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #fbbf24;
            padding: 8px;
            border-radius: 6px;
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            width: 100%;
            margin-bottom: 8px;
        }

        /* ÏßëÏ§ë Î™®Îìú Ïä§ÌÉÄÏùº */
        body.focus-mode #ui-container,
        body.focus-mode .todo-container,
        body.focus-mode .window-frame,
        body.focus-mode .wall-decoration,
        body.focus-mode .fireplace,
        body.focus-mode .christmas-tree {
            display: none !important;
        }

        body.focus-mode .toggle-ui-btn {
            display: none;
        }

        body.focus-mode {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .focus-timer-display {
            display: none;
            text-align: center;
            z-index: 200;
        }

        body.focus-mode .focus-timer-display {
            display: block;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .focus-timer-display .timer {
            font-size: 120px;
            color: #fbbf24;
            text-shadow: 4px 4px 0 #78350f, 0 0 40px rgba(251, 191, 36, 0.5);
            margin-bottom: 30px;
            letter-spacing: 10px;
        }

        .focus-timer-display .status {
            font-size: 24px;
            color: #fbbf24;
            text-shadow: 2px 2px 0 #000;
            margin-bottom: 40px;
            letter-spacing: 3px;
        }

        .focus-timer-display .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .focus-timer-display .focus-btn {
            background: #fbbf24;
            color: #2c1a13;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            box-shadow: 0 6px 0 #78350f;
            transition: all 0.1s;
            font-family: 'Press Start 2P', cursive;
        }

        .focus-timer-display .focus-btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #78350f;
        }

        .focus-timer-display .focus-btn.exit {
            background: #ef4444;
            box-shadow: 0 6px 0 #991b1b;
        }

        /* Ìà¨Îëê Î¶¨Ïä§Ìä∏ Ïä§ÌÉÄÏùº */
        .todo-container {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px;
            z-index: 100;
            background: rgba(40, 20, 10, 0.9);
            border: 4px solid #5d3a2a;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
        }

        .todo-container.minimized {
            height: 60px;
            overflow: hidden;
        }
        
        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #fbbf24;
            cursor: move;
            user-select: none;
        }
        
        .todo-title {
            font-size: 14px;
            color: #fbbf24;
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 1px;
        }
        
        .todo-header-buttons {
            display: flex;
            gap: 8px;
        }

        .todo-toggle-btn {
            background: #3b82f6;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 0 #1e40af;
            transition: all 0.1s;
        }

        .todo-toggle-btn:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #1e40af;
        }

        .todo-add-btn {
            background: #22c55e;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 0 #166534;
            transition: all 0.1s;
        }

        .todo-add-btn:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #166534;
        }
        
        .todo-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .todo-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 6px;
            border: 2px solid #78350f;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .todo-checkbox {
            width: 20px;
            height: 20px;
            min-width: 20px;
            appearance: none;
            border: 3px solid #fbbf24;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            background: #2c1a13;
        }
        
        .todo-checkbox:checked {
            background: #22c55e;
            border-color: #22c55e;
        }
        
        .todo-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        .todo-text {
            flex: 1;
            background: transparent;
            border: none;
            color: #fbbf24;
            font-family: 'Press Start 2P', cursive;
            font-size: 9px;
            outline: none;
            line-height: 1.4;
        }
        
        .todo-text::placeholder {
            color: #78350f;
        }
        
        .todo-text.completed {
            text-decoration: line-through;
            opacity: 0.5;
        }
        
        .todo-delete-btn {
            background: #ef4444;
            color: white;
            width: 24px;
            height: 24px;
            min-width: 24px;
            border-radius: 4px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 0 #991b1b;
            transition: all 0.1s;
        }
        
        .todo-delete-btn:active {
            transform: translateY(2px);
            box-shadow: 0 0 0 #991b1b;
        }
        
        .todo-empty {
            text-align: center;
            color: #78350f;
            font-size: 8px;
            padding: 20px;
        }
        
        .todo-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .todo-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        
        .todo-list::-webkit-scrollbar-thumb {
            background: #78350f;
            border-radius: 4px;
        }
        
        .todo-list::-webkit-scrollbar-thumb:hover {
            background: #fbbf24;
        }

        /* Ï±ÑÌåÖ Ïª®ÌÖåÏù¥ÎÑà Ïä§ÌÉÄÏùº */
        .chat-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 350px;
            height: 450px;
            z-index: 110;
            background: rgba(40, 20, 10, 0.95);
            border: 4px solid #5d3a2a;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
        }

        .chat-container.minimized {
            height: 60px;
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #fbbf24;
            flex-shrink: 0;
        }

        .chat-title {
            font-size: 12px;
            color: #fbbf24;
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 1px;
        }

        .chat-toggle-btn {
            background: #3b82f6;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 0 #1e40af;
            transition: all 0.1s;
        }

        .chat-toggle-btn:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #1e40af;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 4px;
        }

        .chat-message {
            background: rgba(0,0,0,0.3);
            padding: 8px 10px;
            border-radius: 8px;
            border: 2px solid #78350f;
            animation: messageSlideIn 0.3s ease-out;
            word-wrap: break-word;
        }

        @keyframes messageSlideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .chat-message-user {
            font-size: 9px;
            color: #22c55e;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .chat-message-text {
            font-size: 8px;
            color: #fbbf24;
            line-height: 1.4;
        }

        .chat-message-time {
            font-size: 7px;
            color: #78350f;
            margin-top: 4px;
        }

        .chat-input-area {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .chat-username-input {
            width: 100%;
            background: rgba(0,0,0,0.5);
            border: 2px solid #fbbf24;
            padding: 8px;
            border-radius: 6px;
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 9px;
            outline: none;
            margin-bottom: 8px;
        }

        .chat-username-input::placeholder {
            color: #78350f;
        }

        .chat-input {
            flex: 1;
            background: rgba(0,0,0,0.5);
            border: 2px solid #fbbf24;
            padding: 8px;
            border-radius: 6px;
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 9px;
            outline: none;
        }

        .chat-input::placeholder {
            color: #78350f;
        }

        .chat-send-btn {
            background: #22c55e;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 3px 0 #166534;
            transition: all 0.1s;
            font-family: 'Press Start 2P', cursive;
            white-space: nowrap;
        }

        .chat-send-btn:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #166534;
        }

        .chat-send-btn:disabled {
            background: #666;
            box-shadow: 0 3px 0 #333;
            cursor: not-allowed;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #78350f;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #fbbf24;
        }

        body.focus-mode .chat-container {
            display: none !important;
        }

        /* Ïò®ÎùºÏù∏ ÏÇ¨Ïö©Ïûê Î™©Î°ù Ïä§ÌÉÄÏùº */
        .online-users {
            margin-bottom: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border: 2px solid #78350f;
            overflow: hidden;
        }

        .online-users-header {
            padding: 8px;
            background: rgba(251, 191, 36, 0.1);
            border-bottom: 1px solid #78350f;
        }

        .online-users-title {
            font-size: 9px;
            color: #fbbf24;
            font-weight: bold;
        }

        .online-users-list {
            max-height: 120px;
            overflow-y: auto;
            padding: 4px;
        }

        .online-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            border: 1px solid #78350f;
            animation: userFadeIn 0.3s ease-out;
        }

        @keyframes userFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .online-user-info {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }

        .online-user-name {
            font-size: 8px;
            color: #22c55e;
            font-weight: bold;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .online-user-timer {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .online-user-time {
            font-size: 9px;
            color: #fbbf24;
            font-weight: bold;
        }

        .online-user-status {
            font-size: 6px;
            color: #78350f;
            text-transform: uppercase;
        }

        .online-user-status.running {
            color: #22c55e;
        }

        .online-user-status.paused {
            color: #ef4444;
        }

        .online-users-list::-webkit-scrollbar {
            width: 4px;
        }

        .online-users-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 2px;
        }

        .online-users-list::-webkit-scrollbar-thumb {
            background: #78350f;
            border-radius: 2px;
        }

        .online-users-list::-webkit-scrollbar-thumb:hover {
            background: #fbbf24;
        }

        /* YouTube Ïò§ÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ Ïä§ÌÉÄÏùº */
        .yt-audio-controls {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        
        .yt-video-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding: 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }
        
        .yt-video-toggle-btn {
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 8px;
            cursor: pointer;
            border: 2px solid #991b1b;
            transition: all 0.2s;
        }
        
        .yt-video-toggle-btn:hover {
            background: #dc2626;
        }
        
        .yt-video-toggle-btn.active {
            background: #22c55e;
            border-color: #166534;
        }
        
        .yt-video-toggle-label {
            font-size: 8px;
            color: #fbbf24;
        }
        
        .yt-progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(251, 191, 36, 0.2);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .yt-progress-fill {
            height: 100%;
            background: #fbbf24;
            width: 0%;
            transition: width 0.3s;
        }
        
        .yt-time-display {
            font-size: 9px;
            color: #fbbf24;
            letter-spacing: 1px;
        }
        
        .yt-video-container {
            width: 100%;
            margin-top: 8px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #fbbf24;
            display: none;
        }
        
        .yt-video-container.visible {
            display: block;
        }
        
        .yt-video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
        }
        
        .yt-video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="w-full h-screen flex items-center justify-center">

    <div id="scene-container">
        <div class="interior-wall"></div>
        
        <div class="wall-decoration">
            <span class="letter-red">D</span><span class="letter-green">i</span><span class="letter-red">g</span><span class="letter-green">i</span><span class="letter-red">p</span><span class="letter-green">e</span><span class="letter-red">n</span>
            &nbsp;
            <span class="letter-green">H</span><span class="letter-red">a</span><span class="letter-green">n</span><span class="letter-red">g</span><span class="letter-green">o</span><span class="letter-red">u</span><span class="letter-green">t</span>
        </div>

        <div class="window-frame">
            <div class="window-glass">
                <div class="mountain" style="left: -50px; border-bottom-color: #0f172a; transform: scale(0.8);"></div>
                <div class="mountain" style="left: 80px; bottom: -50px; border-width: 0 200px 400px 200px; border-bottom-color: #1e293b;"></div>
                <div class="mountain" style="right: -80px; bottom: -20px; border-width: 0 250px 350px 250px; border-bottom-color: #172554; transform: scale(0.9);"></div>
                <canvas id="snow-canvas"></canvas>
            </div>
        </div>

        <div class="fireplace">
            <div class="fireplace-mantel"></div>
            <div class="fire-pit">
                <div class="fire"></div>
            </div>
        </div>
    </div>

    <button onclick="toggleUI()" class="toggle-ui-btn">üëÅÔ∏è</button>

    <!-- Î™®Îìú Î≤ÑÌäºÎì§ -->
    <div class="mode-buttons">
        <button id="muteBtn" class="mode-btn" onclick="toggleMute()">
            <span id="muteIcon">üîä</span>
            <span id="muteText">SOUND</span>
        </button>
        <button id="focusBtn" class="mode-btn" onclick="toggleFocusMode()">
            üéØ FOCUS
        </button>
    </div>

    <!-- ÏßëÏ§ë Î™®Îìú ÌôîÎ©¥ -->
    <div class="focus-timer-display">
        <div class="timer" id="focusTimer">00:00</div>
        <div class="status" id="focusStatus">READY</div>
        <div class="controls">
            <button class="focus-btn" onclick="startTimer()">START</button>
            <button class="focus-btn" onclick="stopTimer()">PAUSE</button>
            <button class="focus-btn" onclick="resetTimer()">RESET</button>
            <button class="focus-btn exit" onclick="toggleFocusMode()">EXIT</button>
        </div>
    </div>

    <!-- Ìà¨Îëê Î¶¨Ïä§Ìä∏ -->
    <div class="todo-container" id="todoContainer">
        <div class="todo-header" id="todoHeader">
            <div class="todo-title">üìù TODO LIST</div>
            <div class="todo-header-buttons">
                <button class="todo-toggle-btn" onclick="toggleTodoList()">‚àí</button>
                <button class="todo-add-btn" onclick="addTodo()">+</button>
            </div>
        </div>
        <div class="todo-list" id="todoList">
            <div class="todo-empty">Press + to add task!</div>
        </div>
    </div>

    <!-- Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">üí¨ LIVE CHAT</div>
            <button class="chat-toggle-btn" onclick="toggleChat()">‚àí</button>
        </div>
        <input type="text" id="chatUsername" class="chat-username-input" placeholder="Your name..." maxlength="20">

        <!-- Ïò®ÎùºÏù∏ ÏÇ¨Ïö©Ïûê Î™©Î°ù -->
        <div class="online-users" id="onlineUsers">
            <div class="online-users-header">
                <span class="online-users-title">üë• ONLINE (<span id="onlineCount">0</span>)</span>
            </div>
            <div class="online-users-list" id="onlineUsersList">
                <!-- ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="chat-message">
                <div class="chat-message-user">System</div>
                <div class="chat-message-text">Welcome to Digipen Hangout! üéÆ</div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="Type message..." maxlength="200" onkeypress="handleChatKeyPress(event)">
            <button class="chat-send-btn" onclick="sendMessage()">SEND</button>
        </div>
    </div>

    <div id="ui-container" class="p-6 md:p-8 rounded-xl w-[95%] sm:w-[85%] text-white transition-opacity duration-500">
        
        <div class="flex justify-between items-end mb-6 border-b-2 border-amber-900/50 pb-4">
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <div id="recDot" class="w-3 h-3 bg-red-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(239,68,68,0.6)]"></div>
                    <span id="modeDisplay" class="text-xs text-amber-300 tracking-wider">MANUAL MODE</span>
                </div>
                <div id="timerDisplay" class="text-5xl md:text-7xl text-amber-400 font-bold tracking-widest drop-shadow-[0_0_15px_rgba(251,191,36,0.4)]" style="text-shadow: 2px 2px 0px #78350f;">00:00</div>
            </div>
            <div class="text-right">
                <div id="statusText" class="text-xs md:text-sm text-amber-200 mb-2 tracking-widest">READY</div>
                <div class="w-32 h-4 bg-amber-950 rounded border-2 border-amber-900 overflow-hidden">
                    <div id="progressBar" class="h-full bg-amber-500 w-0 transition-all duration-1000"></div>
                </div>
            </div>
        </div>

        <div class="bg-amber-950/60 p-4 rounded-lg mb-6 border border-amber-900/50 shadow-inner">
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs text-amber-200">üéß BGM DECK</span>
                <div class="flex gap-2">
                    <button onclick="toggleAudioMode('file')" class="text-[10px] bg-amber-800 px-3 py-1.5 rounded hover:bg-amber-700 transition-colors border-b-2 border-amber-950">MP3</button>
                    <button onclick="toggleAudioMode('youtube')" class="text-[10px] bg-red-900 px-3 py-1.5 rounded hover:bg-red-800 transition-colors border-b-2 border-red-950">YOUTUBE</button>
                </div>
            </div>

            <div id="filePanel" class="block">
                <input type="file" id="audioFile" accept="audio/*" class="hidden" onchange="handleFileSelect(event)">
                <div class="flex items-center gap-2">
                    <button onclick="document.getElementById('audioFile').click()" class="retro-button bg-amber-800 text-[10px] px-4 py-2 rounded text-white border-b-4 border-amber-950 hover:bg-amber-700">üìÇ LOAD</button>
                    <div class="flex-1 overflow-hidden bg-black/30 p-2 rounded border border-amber-900/30">
                        <div id="fileNameDisplay" class="text-[10px] text-amber-300 truncate">NO CASSETTE LOADED</div>
                    </div>
                    <button onclick="togglePlayMusic()" id="musicPlayBtn" class="retro-button w-10 h-10 bg-amber-600 rounded-full flex items-center justify-center text-xs border-b-4 border-amber-800 hover:bg-amber-500 shadow-lg">‚ñ∂</button>
                </div>
                <audio id="bgmPlayer" loop class="hidden"></audio>
            </div>

            <div id="youtubePanel" class="hidden">
                <div class="flex gap-2 mb-3">
                    <input type="text" id="ytUrl" placeholder="Paste Youtube URL..." class="flex-1 bg-amber-950/50 text-white text-[10px] p-2 border border-amber-800 rounded focus:border-amber-500 outline-none transition-colors">
                    <button onclick="loadYoutube()" class="retro-button bg-red-700 text-white text-[10px] px-3 py-2 rounded border-b-4 border-red-900 hover:bg-red-600">LOAD</button>
                </div>
                
                <!-- YouTube Ïò§ÎîîÏò§ Ïª®Ìä∏Î°§ -->
                <div id="ytAudioControls" class="yt-audio-controls hidden">
                    <!-- ÎπÑÎîîÏò§ ÌëúÏãú ÌÜ†Í∏Ä -->
                    <div class="yt-video-toggle">
                        <button id="ytVideoToggleBtn" onclick="toggleYoutubeVideo()" class="yt-video-toggle-btn">
                            üì∫ VIDEO OFF
                        </button>
                        <span class="yt-video-toggle-label">Toggle video display</span>
                    </div>
                    
                    <div class="flex items-center gap-3 mb-2">
                        <button id="ytPlayBtn" onclick="toggleYoutubePlay()" class="retro-button w-10 h-10 bg-red-600 rounded-full flex items-center justify-center text-xs border-b-4 border-red-800 hover:bg-red-500 shadow-lg">‚ñ∂</button>
                        <div class="flex-1">
                            <div class="yt-progress-bar" id="ytProgressBar" onclick="seekYoutube(event)">
                                <div class="yt-progress-fill" id="ytProgressFill"></div>
                            </div>
                        </div>
                        <div class="yt-time-display" id="ytTimeDisplay">0:00 / 0:00</div>
                    </div>
                    <div class="text-[9px] text-amber-300 truncate" id="ytVideoTitle">YouTube Audio Player</div>
                    
                    <!-- ÎπÑÎîîÏò§ ÌëúÏãú ÏòÅÏó≠ -->
                    <div id="ytVideoContainer" class="yt-video-container">
                        <div class="yt-video-wrapper">
                            <div id="ytPlayerVisible"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Ïà®Í≤®ÏßÑ YouTube iframe (Ïò§ÎîîÏò§ Ï†ÑÏö©) -->
                <div id="ytPlayerContainer" style="position: absolute; left: -9999px; width: 1px; height: 1px;">
                    <div id="ytPlayer"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-3 mb-6">
            <button onclick="setPreset(5)" class="retro-button bg-yellow-600 text-white text-[10px] py-3 rounded border-b-4 border-yellow-800 hover:bg-yellow-500 hover:translate-y-[1px]">5M</button>
            <button onclick="setPreset(10)" class="retro-button bg-orange-600 text-white text-[10px] py-3 rounded border-b-4 border-orange-800 hover:bg-orange-500 hover:translate-y-[1px]">10M</button>
            <button onclick="setPreset(25)" class="retro-button bg-blue-600 text-white text-[10px] py-3 rounded border-b-4 border-blue-800 hover:bg-blue-500 hover:translate-y-[1px]">25M</button>
            <button onclick="setPreset(50)" class="retro-button bg-indigo-600 text-white text-[10px] py-3 rounded border-b-4 border-indigo-800 hover:bg-indigo-500 hover:translate-y-[1px]">50M</button>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="startPomodoroSequence(25, 5)" class="retro-button bg-purple-600 text-white text-[10px] py-3 rounded border-b-4 border-purple-800 relative overflow-hidden group hover:bg-purple-500">
                <span class="relative z-10 flex items-center justify-center gap-1">üçÖ 25/5 POMO</span>
                <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity"></div>
            </button>
            <button onclick="startPomodoroSequence(50, 10)" class="retro-button bg-teal-600 text-white text-[10px] py-3 rounded border-b-4 border-teal-800 relative overflow-hidden group hover:bg-teal-500">
                <span class="relative z-10 flex items-center justify-center gap-1">üß† 50/10 POMO</span>
                <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity"></div>
            </button>
        </div>

        <div class="bg-amber-950/40 p-3 rounded border border-amber-900/30 mb-4">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-amber-200">MY POMO</span>
                <span class="text-[8px] text-amber-600">work/break</span>
            </div>
            <div class="flex items-center gap-2">
                <input type="number" id="presetWork" placeholder="25" class="w-14 bg-transparent border-b-2 border-amber-700 text-center text-sm outline-none text-white focus:border-amber-400 transition-colors">
                <span class="text-amber-500">/</span>
                <input type="number" id="presetBreak" placeholder="5" class="w-14 bg-transparent border-b-2 border-amber-700 text-center text-sm outline-none text-white focus:border-amber-400 transition-colors">
                <button onclick="saveCustomPreset()" class="retro-button ml-auto bg-green-600 text-white text-[10px] px-4 py-1.5 rounded border-b-4 border-green-800 hover:bg-green-500">üíæ SAVE</button>
            </div>
        </div>

        <!-- Ï†ÄÏû•Îêú ÌîÑÎ¶¨ÏÖãÎì§ -->
        <div id="savedPresets" class="grid grid-cols-3 gap-2 mb-6"></div>

        <div class="flex items-center gap-3 mb-6 bg-amber-950/40 p-3 rounded border border-amber-900/30">
            <span class="text-[10px] text-amber-200">CUSTOM</span>
            <input type="number" id="inputMin" placeholder="00" class="w-12 bg-transparent border-b-2 border-amber-700 text-center text-sm outline-none text-white focus:border-amber-400 transition-colors">
            <span class="text-sm text-amber-500">:</span>
            <input type="number" id="inputSec" placeholder="00" class="w-12 bg-transparent border-b-2 border-amber-700 text-center text-sm outline-none text-white focus:border-amber-400 transition-colors">
            <button onclick="setCustom()" class="retro-button ml-auto bg-blue-600 text-white text-[10px] px-4 py-1.5 rounded border-b-4 border-blue-800 hover:bg-blue-500">SET</button>
        </div>

        <div class="flex gap-3">
            <button id="startBtn" onclick="startTimer()" class="retro-button flex-1 bg-amber-600 border-b-4 border-amber-800 text-white py-4 rounded text-sm hover:bg-amber-500 font-bold shadow-lg">START</button>
            <button id="stopBtn" onclick="stopTimer()" class="retro-button flex-1 bg-red-600 border-b-4 border-red-800 text-white py-4 rounded text-sm hover:bg-red-500 hidden font-bold shadow-lg">STOP</button>
            <button onclick="resetTimer()" class="retro-button w-20 bg-amber-800 border-b-4 border-amber-950 text-white py-4 rounded text-sm hover:bg-amber-700 font-bold shadow-lg">R</button>
        </div>
    </div>

    <script>
        // ==========================================
        // Firebase ÏÑ§Ï†ï Î∞è Ï¥àÍ∏∞Ìôî
        // ==========================================

        // Ïó¨Í∏∞Ïóê Firebase ÏÑ§Ï†ïÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî
        // Firebase ConsoleÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏Î•º ÎßåÎì§Í≥† ÏïÑÎûò ÏÑ§Ï†ïÏùÑ Î≥µÏÇ¨Ìï¥ÏÑú Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî
        const firebaseConfig = {
  apiKey: "AIzaSyBa2FDJ0iNsD67G1LvjFxMWN8bzJveQ6yI",
  authDomain: "mytimer-4add6.firebaseapp.com",
  databaseURL: "https://mytimer-4add6-default-rtdb.firebaseio.com",
  projectId: "mytimer-4add6",
  storageBucket: "mytimer-4add6.firebasestorage.app",
  messagingSenderId: "515788166314",
  appId: "1:515788166314:web:d79ed7df9924283e76acd3",
  measurementId: "G-WXR0K507LE"
};

        // Firebase Ï¥àÍ∏∞Ìôî
        let database = null;
        let chatRef = null;
        let usersRef = null;
        let myUserRef = null;
        let myUserId = null;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            chatRef = database.ref('messages');
            usersRef = database.ref('users');
            console.log('Firebase connected successfully!');

            // Ïã§ÏãúÍ∞Ñ Î©îÏãúÏßÄ Î¶¨Ïä§ÎÑà
            chatRef.limitToLast(50).on('child_added', function(snapshot) {
                const message = snapshot.val();
                displayMessage(message, false);
            });

            // Ïò®ÎùºÏù∏ ÏÇ¨Ïö©Ïûê Î¶¨Ïä§ÎÑà
            usersRef.on('value', function(snapshot) {
                updateOnlineUsers(snapshot.val());
            });

        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('chatMessages').innerHTML = `
                <div class="chat-message">
                    <div class="chat-message-user">System</div>
                    <div class="chat-message-text" style="color: #ef4444;">Firebase not configured. Please set up your Firebase project.</div>
                </div>
            `;
        }

        // ==========================================
        // Ï±ÑÌåÖ Í∏∞Îä•
        // ==========================================

        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            const toggleBtn = chatContainer.querySelector('.chat-toggle-btn');

            if (chatContainer.classList.contains('minimized')) {
                chatContainer.classList.remove('minimized');
                toggleBtn.textContent = '‚àí';
            } else {
                chatContainer.classList.add('minimized');
                toggleBtn.textContent = '+';
            }

            if (!isMuted) playBeep();
        }

        function sendMessage() {
            if (!chatRef) {
                alert('Firebase is not configured. Please check the console for instructions.');
                return;
            }

            const username = document.getElementById('chatUsername').value.trim();
            const messageText = document.getElementById('chatInput').value.trim();

            if (!username) {
                alert('Please enter your name!');
                document.getElementById('chatUsername').focus();
                return;
            }

            if (!messageText) {
                return;
            }

            // Î©îÏãúÏßÄ Í∞ùÏ≤¥ ÏÉùÏÑ±
            const message = {
                username: username,
                text: messageText,
                timestamp: Date.now()
            };

            // FirebaseÏóê Î©îÏãúÏßÄ Ï†ÄÏû•
            chatRef.push(message)
                .then(() => {
                    document.getElementById('chatInput').value = '';
                    if (!isMuted) playBeep();
                })
                .catch((error) => {
                    console.error('Error sending message:', error);
                    alert('Failed to send message. Please try again.');
                });
        }

        function displayMessage(message, skipScroll = false) {
            const messagesContainer = document.getElementById('chatMessages');

            // ÏãúÏä§ÌÖú Î©îÏãúÏßÄ Ï†úÍ±∞ (Ï≤´ Î©îÏãúÏßÄÍ∞Ä Îì§Ïñ¥Ïò¨ Îïå)
            const systemMsg = messagesContainer.querySelector('.chat-message');
            if (systemMsg && systemMsg.querySelector('.chat-message-user').textContent === 'System') {
                // Ïã§Ï†ú Î©îÏãúÏßÄÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
                if (messagesContainer.children.length === 1 && message.username !== 'System') {
                    systemMsg.remove();
                }
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';

            const time = new Date(message.timestamp);
            const timeString = time.getHours().toString().padStart(2, '0') + ':' +
                               time.getMinutes().toString().padStart(2, '0');

            messageDiv.innerHTML = `
                <div class="chat-message-user">${escapeHtml(message.username)}</div>
                <div class="chat-message-text">${escapeHtml(message.text)}</div>
                <div class="chat-message-time">${timeString}</div>
            `;

            messagesContainer.appendChild(messageDiv);

            // Î©îÏãúÏßÄ Í∞úÏàò Ï†úÌïú (ÏµúÎåÄ 50Í∞ú)
            while (messagesContainer.children.length > 50) {
                messagesContainer.removeChild(messagesContainer.firstChild);
            }

            // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú
            if (!skipScroll) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ÏÇ¨Ïö©Ïûê Ïù¥Î¶ÑÏùÑ Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
        window.addEventListener('DOMContentLoaded', function() {
            const savedUsername = localStorage.getItem('digipen_chat_username');
            if (savedUsername) {
                document.getElementById('chatUsername').value = savedUsername;
            }

            document.getElementById('chatUsername').addEventListener('change', function() {
                localStorage.setItem('digipen_chat_username', this.value);
                updateMyUserStatus(); // Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Ïãú Firebase ÏóÖÎç∞Ïù¥Ìä∏
            });
        });

        // ==========================================
        // Ïò®ÎùºÏù∏ ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨
        // ==========================================

        // ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÎ•º FirebaseÏóê Îì±Î°ù
        function registerUser() {
            if (!usersRef) return;

            const username = document.getElementById('chatUsername').value.trim();
            if (!username) return;

            // Í≥†Ïú† ID ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
            if (!myUserId) {
                myUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            myUserRef = usersRef.child(myUserId);

            // Ïó∞Í≤∞ Ìï¥Ï†ú Ïãú ÏûêÎèô ÏÇ≠Ï†ú
            myUserRef.onDisconnect().remove();

            // Ï¥àÍ∏∞ ÏÉÅÌÉú Îì±Î°ù
            updateMyUserStatus();
        }

        // ÎÇ¥ ÌÉÄÏù¥Î®∏ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateMyUserStatus() {
            if (!myUserRef) {
                registerUser();
                return;
            }

            const username = document.getElementById('chatUsername').value.trim();
            if (!username) return;

            const m = Math.floor(remainingSeconds / 60);
            const s = remainingSeconds % 60;
            const timeText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

            const userStatus = {
                username: username,
                time: timeText,
                remainingSeconds: remainingSeconds,
                totalSeconds: totalSeconds,
                isRunning: isRunning,
                isPomodoroMode: isPomodoroMode,
                status: isRunning ? 'running' : (remainingSeconds > 0 ? 'paused' : 'idle'),
                lastUpdate: Date.now()
            };

            myUserRef.set(userStatus).catch(err => {
                console.error('Failed to update user status:', err);
            });
        }

        // Ïò®ÎùºÏù∏ ÏÇ¨Ïö©Ïûê Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateOnlineUsers(users) {
            const usersList = document.getElementById('onlineUsersList');
            const onlineCount = document.getElementById('onlineCount');

            if (!users) {
                usersList.innerHTML = '<div style="text-align: center; padding: 10px; font-size: 7px; color: #78350f;">No users online</div>';
                onlineCount.textContent = '0';
                return;
            }

            const now = Date.now();
            const activeUsers = [];

            // 30Ï¥à Ïù¥ÎÇ¥Ïóê ÏóÖÎç∞Ïù¥Ìä∏Îêú ÏÇ¨Ïö©ÏûêÎßå ÌëúÏãú
            Object.keys(users).forEach(userId => {
                const user = users[userId];
                if (user && user.lastUpdate && (now - user.lastUpdate) < 30000) {
                    activeUsers.push({ id: userId, ...user });
                }
            });

            onlineCount.textContent = activeUsers.length;

            if (activeUsers.length === 0) {
                usersList.innerHTML = '<div style="text-align: center; padding: 10px; font-size: 7px; color: #78350f;">No users online</div>';
                return;
            }

            usersList.innerHTML = '';
            activeUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'online-user-item';

                const isMe = user.id === myUserId;
                const statusClass = user.status === 'running' ? 'running' : (user.status === 'paused' ? 'paused' : '');

                userItem.innerHTML = `
                    <div class="online-user-info">
                        <span class="online-user-name">${escapeHtml(user.username)}${isMe ? ' (You)' : ''}</span>
                    </div>
                    <div class="online-user-timer">
                        <span class="online-user-time">${user.time || '00:00'}</span>
                        <span class="online-user-status ${statusClass}">${user.status || 'idle'}</span>
                    </div>
                `;

                usersList.appendChild(userItem);
            });
        }

        // ==========================================
        // Í∏∞Ï°¥ ÏΩîÎìú
        // ==========================================

        const scene = document.getElementById('scene-container');
        
        function createTree() {
            const tree = document.createElement('div');
            tree.className = 'christmas-tree';
            
            // Î≥Ñ
            const star = document.createElement('div');
            star.className = 'tree-star';
            tree.appendChild(star);

            // Ìä∏Î¶¨ Î†àÏù¥Ïñ¥Îì§ (ÏúÑÏóêÏÑú ÏïÑÎûòÎ°ú Ï†êÏ†ê Ïª§ÏßÄÍ≤å)
            const layers = [
                { width: 40, height: 50 },   // Îß® ÏúÑ
                { width: 60, height: 60 },
                { width: 80, height: 70 },
                { width: 100, height: 80 },
                { width: 120, height: 90 },
                { width: 140, height: 100 }  // Îß® ÏïÑÎûò
            ];
            
            const colors = ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#a855f7', '#ec4899'];
            
            layers.forEach((layerSize, index) => {
                const layer = document.createElement('div');
                layer.className = 'tree-layer';
                layer.style.borderLeftWidth = layerSize.width + 'px';
                layer.style.borderRightWidth = layerSize.width + 'px';
                layer.style.borderBottomWidth = layerSize.height + 'px';
                
                // Í∞Å Î†àÏù¥Ïñ¥Ïóê Ï†ÑÍµ¨ Ï∂îÍ∞Ä
                const numLights = 3 + index;
                for (let i = 0; i < numLights; i++) {
                    const light = document.createElement('div');
                    light.className = 'tree-light';
                    
                    // Ï†ÑÍµ¨Î•º ÏÇºÍ∞ÅÌòï ÏïàÏóê ÎûúÎç§ÌïòÍ≤å Î∞∞Ïπò
                    const xPos = (Math.random() * layerSize.width * 1.6) - (layerSize.width * 0.8);
                    const yPos = Math.random() * (layerSize.height * 0.7) + 10;
                    
                    // ÏÇºÍ∞ÅÌòï Í≤ΩÍ≥Ñ ÏïàÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
                    if (Math.abs(xPos) < (layerSize.height - yPos) * (layerSize.width / layerSize.height)) {
                        light.style.left = `calc(50% + ${xPos}px)`;
                        light.style.top = `${yPos}px`;
                        light.style.background = colors[Math.floor(Math.random() * colors.length)];
                        light.style.animationDelay = (Math.random() * 1.5) + 's';
                        layer.appendChild(light);
                    }
                }
                
                tree.appendChild(layer);
            });
            
            // ÎÇòÎ¨¥ Ï§ÑÍ∏∞
            const trunk = document.createElement('div');
            trunk.className = 'tree-trunk';
            tree.appendChild(trunk);

            scene.appendChild(tree);
        }
        createTree();

        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        const particles = [];

        function resize() {
            width = canvas.width = 320;
            height = canvas.height = 420;
        }
        resize();

        class Particle {
            constructor() {
                this.reset();
            }
            reset() {
                this.x = Math.random() * width;
                this.y = Math.random() * -height;
                this.vy = 0.5 + Math.random() * 1.5;
                this.size = 1.5 + Math.random() * 2;
                this.opacity = 0.5 + Math.random() * 0.5;
            }
            update() {
                this.y += this.vy;
                if (this.y > height) this.reset();
            }
            draw() {
                ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        for (let i = 0; i < 60; i++) particles.push(new Particle());

        function animateSnow() {
            ctx.clearRect(0, 0, width, height);
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(animateSnow);
        }
        animateSnow();

        // Timer variables
        let timerInterval;
        let totalSeconds = 0;
        let remainingSeconds = 0;
        let isRunning = false;
        let isPomodoroMode = false;
        let isWorkSession = true; 
        
        const display = document.getElementById('timerDisplay');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const modeDisplay = document.getElementById('modeDisplay');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const recDot = document.getElementById('recDot');
        const uiContainer = document.getElementById('ui-container');
        
        const filePanel = document.getElementById('filePanel');
        const youtubePanel = document.getElementById('youtubePanel');
        const bgmPlayer = document.getElementById('bgmPlayer');
        const musicPlayBtn = document.getElementById('musicPlayBtn');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // YouTube Player variables
        let ytPlayer = null;
        let ytPlayerVisible = null;
        let ytUpdateInterval = null;
        let isYouTubeAPIReady = false;
        let isVideoVisible = false;
        let currentVideoId = '';
        
        // Todo List variables
        let todoItems = [];
        let todoIdCounter = 0;
        
        // Mode variables
        let isMuted = false;
        let isFocusMode = false;
        
        // Custom Pomodoro presets - {work: minutes, break: minutes}
        let customPresets = [];
        
        // Current Pomodoro settings
        let currentWorkTime = 25;
        let currentBreakTime = 5;
        
        // Share feature
        let autoStartTimeout = null;

        // YouTube APIÍ∞Ä Î°úÎìúÎêòÎ©¥ Ìò∏Ï∂úÎê©ÎãàÎã§
        window.onYouTubeIframeAPIReady = function() {
            console.log('YouTube API Ready');
            isYouTubeAPIReady = true;
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        window.addEventListener('DOMContentLoaded', function() {
            loadTodosFromStorage();
            loadCustomPresets();
            loadMuteState();
            handleUrlParams();

            // ÏÇ¨Ïö©Ïûê Îì±Î°ù (usernameÏù¥ ÏûàÏúºÎ©¥)
            setTimeout(() => {
                const username = document.getElementById('chatUsername').value.trim();
                if (username) {
                    registerUser();
                }
            }, 1000);
        });
        
        // URL ÌååÎùºÎØ∏ÌÑ∞ Ï≤òÎ¶¨
        function handleUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // ÎΩÄÎ™®ÎèÑÎ°ú ÏÑ§Ï†ï (Ïòà: ?pomo=25/5)
            const pomoParam = urlParams.get('pomo');
            if (pomoParam) {
                const [work, breakTime] = pomoParam.split('/').map(Number);
                if (work && breakTime) {
                    currentWorkTime = work;
                    currentBreakTime = breakTime;
                    
                    // URL ÌååÎùºÎØ∏ÌÑ∞ ÏûàÏúºÎ©¥ ÏûêÎèô ÏïåÎ¶º
                    setTimeout(() => {
                        if (confirm(`ÏπúÍµ¨Í∞Ä ${work}Î∂Ñ/${breakTime}Î∂Ñ ÎΩÄÎ™®ÎèÑÎ°úÎ°ú Ï¥àÎåÄÌñàÏñ¥Ïöî! ÏãúÏûëÌï†ÍπåÏöî?`)) {
                            startPomodoroSequence(work, breakTime);
                        }
                    }, 500);
                }
            }
            
            // ÏùºÎ∞ò ÌÉÄÏù¥Î®∏ (Ïòà: ?timer=25)
            const timerParam = urlParams.get('timer');
            if (timerParam && !pomoParam) {
                const minutes = Number(timerParam);
                if (minutes > 0) {
                    setTimeout(() => {
                        if (confirm(`ÏπúÍµ¨Í∞Ä ${minutes}Î∂Ñ ÌÉÄÏù¥Î®∏Î°ú Ï¥àÎåÄÌñàÏñ¥Ïöî! ÏÑ§Ï†ïÌï†ÍπåÏöî?`)) {
                            setPreset(minutes);
                        }
                    }, 500);
                }
            }
            
            // ÏûêÎèô ÏãúÏûë (Ïòà: ?startin=300 -> 5Î∂Ñ ÌõÑ)
            const startInParam = urlParams.get('startin');
            if (startInParam) {
                const seconds = Number(startInParam);
                if (seconds > 0) {
                    const minutes = Math.floor(seconds / 60);
                    statusText.textContent = `AUTO START: ${minutes}M`;
                    
                    const focusStatus = document.getElementById('focusStatus');
                    if (focusStatus) {
                        focusStatus.textContent = `AUTO START: ${minutes}M`;
                    }
                    
                    let countdown = seconds;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        const m = Math.floor(countdown / 60);
                        const s = countdown % 60;
                        statusText.textContent = `AUTO START: ${m}:${s.toString().padStart(2, '0')}`;
                        
                        if (focusStatus) {
                            focusStatus.textContent = `AUTO START: ${m}:${s.toString().padStart(2, '0')}`;
                        }
                        
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            if (!isMuted) playBeep();
                            startTimer();
                        }
                    }, 1000);
                }
            }
        }
        
        // LocalStorage Í¥ÄÎ†® Ìï®ÏàòÎì§
        function saveTodosToStorage() {
            const todos = Array.from(document.querySelectorAll('.todo-item')).map(item => {
                const checkbox = item.querySelector('.todo-checkbox');
                const textInput = item.querySelector('.todo-text');
                return {
                    id: parseInt(item.dataset.id),
                    text: textInput.value,
                    completed: checkbox.checked
                };
            });
            localStorage.setItem('digipen_todos', JSON.stringify(todos));
        }
        
        function loadTodosFromStorage() {
            const saved = localStorage.getItem('digipen_todos');
            if (saved) {
                const todos = JSON.parse(saved);
                const todoList = document.getElementById('todoList');
                
                if (todos.length > 0) {
                    // Îπà Î©îÏãúÏßÄ Ï†úÍ±∞
                    const emptyMsg = todoList.querySelector('.todo-empty');
                    if (emptyMsg) emptyMsg.remove();
                    
                    todos.forEach(todo => {
                        const todoItem = document.createElement('div');
                        todoItem.className = 'todo-item';
                        todoItem.dataset.id = todo.id;
                        
                        todoItem.innerHTML = `
                            <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(${todo.id})">
                            <input type="text" class="todo-text ${todo.completed ? 'completed' : ''}" value="${todo.text}" placeholder="Type your task..." maxlength="50" onchange="saveTodosToStorage()">
                            <button class="todo-delete-btn" onclick="deleteTodo(${todo.id})">√ó</button>
                        `;
                        
                        todoList.appendChild(todoItem);
                        todoIdCounter = Math.max(todoIdCounter, todo.id + 1);
                    });
                    
                    todoItems = todos;
                }
            }
        }
        
        function saveCustomPresets() {
            localStorage.setItem('digipen_presets', JSON.stringify(customPresets));
        }
        
        function loadCustomPresets() {
            const saved = localStorage.getItem('digipen_presets');
            if (saved) {
                customPresets = JSON.parse(saved);
                renderCustomPresets();
            }
        }
        
        function renderCustomPresets() {
            const container = document.getElementById('savedPresets');
            container.innerHTML = '';
            
            customPresets.forEach((preset, index) => {
                const btn = document.createElement('button');
                btn.className = 'retro-button bg-pink-600 text-white text-[9px] py-2 px-2 rounded border-b-4 border-pink-800 hover:bg-pink-500 relative group';
                btn.innerHTML = `
                    üçÖ ${preset.work}/${preset.break}
                    <span class="absolute -top-1 -right-1 bg-red-600 text-white rounded-full w-4 h-4 text-[8px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="deletePreset(${index}, event)">√ó</span>
                `;
                btn.onclick = (e) => {
                    if (!e.target.classList.contains('cursor-pointer')) {
                        startPomodoroSequence(preset.work, preset.break);
                    }
                };
                container.appendChild(btn);
            });
        }
        
        function loadMuteState() {
            const saved = localStorage.getItem('digipen_muted');
            if (saved === 'true') {
                isMuted = true;
                updateMuteButton();
            }
        }
        
        function saveMuteState() {
            localStorage.setItem('digipen_muted', isMuted.toString());
        }
        
        // Todo Functions
        function addTodo() {
            const todoList = document.getElementById('todoList');
            
            // Îπà Î©îÏãúÏßÄ Ï†úÍ±∞
            const emptyMsg = todoList.querySelector('.todo-empty');
            if (emptyMsg) {
                emptyMsg.remove();
            }
            
            // ÏÉà Ìà¨Îëê ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
            const todoId = todoIdCounter++;
            const todoItem = document.createElement('div');
            todoItem.className = 'todo-item';
            todoItem.dataset.id = todoId;
            
            todoItem.innerHTML = `
                <input type="checkbox" class="todo-checkbox" onchange="toggleTodo(${todoId})">
                <input type="text" class="todo-text" placeholder="Type your task..." maxlength="50" onchange="saveTodosToStorage()">
                <button class="todo-delete-btn" onclick="deleteTodo(${todoId})">√ó</button>
            `;
            
            todoList.appendChild(todoItem);
            
            // Ï∂îÍ∞ÄÎêú Ìï≠Î™©Ïóê Ìè¨Ïª§Ïä§
            const input = todoItem.querySelector('.todo-text');
            input.focus();
            
            // Beep ÏÇ¨Ïö¥Îìú
            if (!isMuted) playBeep();
            
            // Ìà¨Îëê Î∞∞Ïó¥Ïóê Ï∂îÍ∞Ä
            todoItems.push({
                id: todoId,
                text: '',
                completed: false
            });
            
            // Ï†ÄÏû•
            saveTodosToStorage();
        }
        
        function toggleTodo(todoId) {
            const todoItem = document.querySelector(`.todo-item[data-id="${todoId}"]`);
            const checkbox = todoItem.querySelector('.todo-checkbox');
            const textInput = todoItem.querySelector('.todo-text');
            
            if (checkbox.checked) {
                textInput.classList.add('completed');
                if (!isMuted) playBeep();
            } else {
                textInput.classList.remove('completed');
            }
            
            // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const todo = todoItems.find(t => t.id === todoId);
            if (todo) {
                todo.completed = checkbox.checked;
            }
            
            // Ï†ÄÏû•
            saveTodosToStorage();
        }
        
        function deleteTodo(todoId) {
            const todoItem = document.querySelector(`.todo-item[data-id="${todoId}"]`);
            const todoList = document.getElementById('todoList');
            
            // ÏÇ≠Ï†ú Ïï†ÎãàÎ©îÏù¥ÏÖò
            todoItem.style.animation = 'slideOut 0.3s ease-out';
            
            setTimeout(() => {
                todoItem.remove();
                
                // Î∞∞Ïó¥ÏóêÏÑú Ï†úÍ±∞
                todoItems = todoItems.filter(t => t.id !== todoId);
                
                // Î™®Îì† Ìà¨ÎëêÍ∞Ä ÏÇ≠Ï†úÎêòÎ©¥ Îπà Î©îÏãúÏßÄ ÌëúÏãú
                if (todoList.children.length === 0) {
                    todoList.innerHTML = '<div class="todo-empty">Press + to add task!</div>';
                }
                
                // Ï†ÄÏû•
                saveTodosToStorage();
            }, 300);
            
            if (!isMuted) playBeep();
        }
        
        // Ïä¨ÎùºÏù¥Îìú ÏïÑÏõÉ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï∂îÍ∞Ä
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(30px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // TODO Î¶¨Ïä§Ìä∏ Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞
        function toggleTodoList() {
            const todoContainer = document.getElementById('todoContainer');
            const toggleBtn = document.querySelector('.todo-toggle-btn');

            if (todoContainer.classList.contains('minimized')) {
                todoContainer.classList.remove('minimized');
                toggleBtn.textContent = '‚àí';
            } else {
                todoContainer.classList.add('minimized');
                toggleBtn.textContent = '+';
            }

            if (!isMuted) playBeep();
        }

        // TODO Î¶¨Ïä§Ìä∏ ÎìúÎûòÍ∑∏ Ïù¥Îèô
        let isDraggingTodo = false;
        let currentTodoX, currentTodoY, initialTodoX, initialTodoY;
        let xOffset = 0, yOffset = 0;

        const todoContainer = document.getElementById('todoContainer');
        const todoHeader = document.getElementById('todoHeader');

        todoHeader.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            if (e.target.closest('.todo-toggle-btn') || e.target.closest('.todo-add-btn')) {
                return;
            }

            initialTodoX = e.clientX - xOffset;
            initialTodoY = e.clientY - yOffset;

            if (e.target === todoHeader || e.target.closest('.todo-title')) {
                isDraggingTodo = true;
                todoContainer.style.transition = 'none';
            }
        }

        function drag(e) {
            if (isDraggingTodo) {
                e.preventDefault();
                currentTodoX = e.clientX - initialTodoX;
                currentTodoY = e.clientY - initialTodoY;

                xOffset = currentTodoX;
                yOffset = currentTodoY;

                setTodoTranslate(currentTodoX, currentTodoY);
            }
        }

        function setTodoTranslate(xPos, yPos) {
            todoContainer.style.right = 'auto';
            todoContainer.style.top = 'auto';
            todoContainer.style.left = (20 + xPos) + 'px';
            todoContainer.style.bottom = (window.innerHeight - 500 - yPos) + 'px';
        }

        function dragEnd(e) {
            if (isDraggingTodo) {
                initialTodoX = currentTodoX;
                initialTodoY = currentTodoY;
                isDraggingTodo = false;
                todoContainer.style.transition = '';
            }
        }

        // Mode Functions
        function toggleMute() {
            isMuted = !isMuted;
            updateMuteButton();
            saveMuteState();
            
            // ÌÜ†Í∏Ä Ïãú ÌîºÎìúÎ∞± ÏÇ¨Ïö¥Îìú (ÎÆ§Ìä∏ Ìï¥Ï†úÌï† ÎïåÎßå)
            if (!isMuted) {
                playBeep();
            }
        }
        
        function updateMuteButton() {
            const muteBtn = document.getElementById('muteBtn');
            const muteIcon = document.getElementById('muteIcon');
            const muteText = document.getElementById('muteText');
            
            if (isMuted) {
                muteBtn.classList.add('muted');
                muteIcon.textContent = 'üîá';
                muteText.textContent = 'MUTED';
            } else {
                muteBtn.classList.remove('muted');
                muteIcon.textContent = 'üîä';
                muteText.textContent = 'SOUND';
            }
        }
        
        function toggleFocusMode() {
            isFocusMode = !isFocusMode;
            const focusBtn = document.getElementById('focusBtn');
            
            if (isFocusMode) {
                document.body.classList.add('focus-mode');
                focusBtn.classList.add('active');
            } else {
                document.body.classList.remove('focus-mode');
                focusBtn.classList.remove('active');
            }
            
            if (!isMuted) playBeep();
        }
        
        function saveCustomPreset() {
            const workMin = parseInt(document.getElementById('presetWork').value);
            const breakMin = parseInt(document.getElementById('presetBreak').value);
            
            if (!workMin || workMin <= 0 || !breakMin || breakMin <= 0) {
                alert('Í≥µÎ∂ÄÏãúÍ∞ÑÍ≥º Ìú¥ÏãùÏãúÍ∞ÑÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            // Ï§ëÎ≥µ Ï≤¥ÌÅ¨
            const isDuplicate = customPresets.some(p => p.work === workMin && p.break === breakMin);
            if (isDuplicate) {
                alert('Ïù¥ÎØ∏ Ï†ÄÏû•Îêú ÌîÑÎ¶¨ÏÖãÏûÖÎãàÎã§!');
                return;
            }
            
            customPresets.push({ work: workMin, break: breakMin });
            saveCustomPresets();
            renderCustomPresets();
            
            document.getElementById('presetWork').value = '';
            document.getElementById('presetBreak').value = '';
            if (!isMuted) playBeep();
        }
        
        function deletePreset(index, event) {
            event.stopPropagation();
            customPresets.splice(index, 1);
            saveCustomPresets();
            renderCustomPresets();
            if (!isMuted) playBeep();
        }
        
        // Share Feature Functions
        function openShareModal() {
            const modal = document.getElementById('shareModal');
            modal.classList.add('active');
            updateShareUrls();
            if (!isMuted) playBeep();
        }
        
        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            modal.classList.remove('active');
            if (!isMuted) playBeep();
        }
        
        function updateShareUrls() {
            const baseUrl = window.location.origin + window.location.pathname;
            
            // ÌòÑÏû¨ ÏÑ§Ï†ï URL
            let currentUrl = baseUrl;
            if (isPomodoroMode) {
                currentUrl += `?pomo=${currentWorkTime}/${currentBreakTime}`;
            } else if (totalSeconds > 0) {
                const minutes = Math.floor(totalSeconds / 60);
                currentUrl += `?timer=${minutes}`;
            } else {
                currentUrl += `?pomo=25/5`;
            }
            
            document.getElementById('shareUrlCurrent').textContent = currentUrl;
            
            // ÏãúÍ∞Ñ ÏßÄÏó∞ URL ÏóÖÎç∞Ïù¥Ìä∏
            const startInMinutes = parseInt(document.getElementById('shareStartIn').value) || 5;
            const startInSeconds = startInMinutes * 60;
            let timedUrl = currentUrl + `&startin=${startInSeconds}`;
            document.getElementById('shareUrlTimed').textContent = timedUrl;
        }
        
        function copyShareUrl(type) {
            let url;
            let buttonId;
            
            if (type === 'current') {
                url = document.getElementById('shareUrlCurrent').textContent;
                buttonId = 'current';
            } else {
                // ÏãúÍ∞Ñ ÏßÄÏó∞ URL Îã§Ïãú ÏÉùÏÑ± (ÏµúÏã† Í∞í Î∞òÏòÅ)
                updateShareUrls();
                url = document.getElementById('shareUrlTimed').textContent;
                buttonId = 'timed';
            }
            
            // ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨
            navigator.clipboard.writeText(url).then(() => {
                // Î≥µÏÇ¨ ÏÑ±Í≥µ ÌîºÎìúÎ∞±
                const buttons = document.querySelectorAll('.share-button');
                buttons.forEach(btn => {
                    if (btn.textContent.includes('COPY')) {
                        const originalText = btn.textContent;
                        btn.textContent = '‚úì COPIED!';
                        btn.classList.add('copied');
                        
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.classList.remove('copied');
                        }, 2000);
                    }
                });
                
                if (!isMuted) playBeep();
            }).catch(err => {
                alert('Î≥µÏÇ¨ Ïã§Ìå®! URLÏùÑ ÏßÅÏ†ë ÏÑ†ÌÉùÌï¥ÏÑú Î≥µÏÇ¨Ìï¥Ï£ºÏÑ∏Ïöî.');
            });
        }
        
        // shareStartIn ÏûÖÎ†• Î≥ÄÍ≤Ω Ïãú URL ÏóÖÎç∞Ïù¥Ìä∏
        document.addEventListener('DOMContentLoaded', function() {
            const shareStartInInput = document.getElementById('shareStartIn');
            if (shareStartInInput) {
                shareStartInInput.addEventListener('input', updateShareUrls);
            }
        });

        function toggleUI() {
            if (uiContainer.style.opacity === '0') {
                uiContainer.style.opacity = '1';
                uiContainer.style.pointerEvents = 'auto';
            } else {
                uiContainer.style.opacity = '0';
                uiContainer.style.pointerEvents = 'none';
            }
        }

        function toggleAudioMode(mode) {
            if (mode === 'file') {
                filePanel.classList.remove('hidden');
                filePanel.classList.add('block');
                youtubePanel.classList.add('hidden');
                youtubePanel.classList.remove('block');
                
                // YouTube Ï†ïÏßÄ
                try {
                    if (ytPlayer && ytPlayer.pauseVideo) {
                        ytPlayer.pauseVideo();
                    }
                    if (ytPlayerVisible && ytPlayerVisible.pauseVideo) {
                        ytPlayerVisible.pauseVideo();
                    }
                    if (ytUpdateInterval) {
                        clearInterval(ytUpdateInterval);
                    }
                    
                    // ÎπÑÎîîÏò§ Ïà®Í∏∞Í∏∞
                    if (isVideoVisible) {
                        const videoContainer = document.getElementById('ytVideoContainer');
                        const toggleBtn = document.getElementById('ytVideoToggleBtn');
                        videoContainer.classList.remove('visible');
                        toggleBtn.classList.remove('active');
                        toggleBtn.innerHTML = 'üì∫ VIDEO OFF';
                        isVideoVisible = false;
                    }
                } catch(e) {
                    console.error('YouTube pause error:', e);
                }
            } else {
                filePanel.classList.add('hidden');
                filePanel.classList.remove('block');
                youtubePanel.classList.remove('hidden');
                youtubePanel.classList.add('block');
                
                // MP3 Ï†ïÏßÄ
                bgmPlayer.pause();
                musicPlayBtn.innerHTML = '‚ñ∂';
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const objectUrl = URL.createObjectURL(file);
                bgmPlayer.src = objectUrl;
                fileNameDisplay.textContent = file.name;
                musicPlayBtn.innerHTML = '‚ñ∂'; 
            }
        }

        function togglePlayMusic() {
            if (!bgmPlayer.src) {
                alert("MP3 ÌååÏùºÏùÑ Î®ºÏ†Ä Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }
            if (bgmPlayer.paused) {
                bgmPlayer.play();
                musicPlayBtn.innerHTML = '‚ùö‚ùö';
            } else {
                bgmPlayer.pause();
                musicPlayBtn.innerHTML = '‚ñ∂';
            }
        }

        function loadYoutube() {
            const urlInput = document.getElementById('ytUrl').value;
            let videoId = '';
            
            if (urlInput.includes('v=')) {
                videoId = urlInput.split('v=')[1].split('&')[0];
            } else if (urlInput.includes('youtu.be/')) {
                videoId = urlInput.split('youtu.be/')[1].split('?')[0];
            }
            
            if (!videoId) {
                alert('Ïò¨Î∞îÎ•∏ YouTube URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // YouTube APIÍ∞Ä Î°úÎìúÎê† ÎïåÍπåÏßÄ Í∏∞Îã§Î¶¨Í∏∞
            if (typeof YT === 'undefined' || !YT.Player) {
                alert('YouTube APIÎ•º Î°úÎìúÌïòÎäî Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                // 3Ï¥à ÌõÑ ÏûêÎèô Ïû¨ÏãúÎèÑ
                setTimeout(() => {
                    if (typeof YT !== 'undefined' && YT.Player) {
                        loadYoutubePlayer(videoId);
                    }
                }, 3000);
                return;
            }
            
            loadYoutubePlayer(videoId);
        }
        
        function loadYoutubePlayer(videoId) {
            currentVideoId = videoId;

            // Í∏∞Ï°¥ ÌîåÎ†àÏù¥Ïñ¥ Ï†úÍ±∞
            if (ytPlayer) {
                try {
                    ytPlayer.destroy();
                } catch(e) {}
            }
            if (ytPlayerVisible) {
                try {
                    ytPlayerVisible.destroy();
                } catch(e) {}
            }

            // Î©îÏù∏ ÌîåÎ†àÏù¥Ïñ¥ (Ìï≠ÏÉÅ Ïû¨ÏÉùÎê®)
            ytPlayer = new YT.Player('ytPlayer', {
                height: '1',
                width: '1',
                videoId: videoId,
                playerVars: {
                    'autoplay': 0,
                    'controls': 0,
                    'disablekb': 1,
                    'fs': 0,
                    'modestbranding': 1,
                    'rel': 0
                },
                events: {
                    'onReady': onYoutubePlayerReady,
                    'onStateChange': onYoutubePlayerStateChange
                }
            });

            // ÎπÑÎîîÏò§ ÌëúÏãúÏö© ÌîåÎ†àÏù¥Ïñ¥ (ÎèôÍ∏∞Ìôî)
            ytPlayerVisible = new YT.Player('ytPlayerVisible', {
                height: '360',
                width: '640',
                videoId: videoId,
                playerVars: {
                    'autoplay': 0,
                    'controls': 1,
                    'modestbranding': 1,
                    'rel': 0
                },
                events: {
                    'onReady': function(event) {
                        // Ï§ÄÎπÑÎêòÎ©¥ Ïà®ÍπÄ ÏÉÅÌÉúÎ°ú ÏãúÏûë
                        console.log('Video player ready');
                    },
                    'onStateChange': onVisiblePlayerStateChange
                }
            });
        }
        
        function toggleYoutubeVideo() {
            const videoContainer = document.getElementById('ytVideoContainer');
            const toggleBtn = document.getElementById('ytVideoToggleBtn');

            isVideoVisible = !isVideoVisible;

            if (isVideoVisible) {
                videoContainer.classList.add('visible');
                toggleBtn.classList.add('active');
                toggleBtn.innerHTML = 'üì∫ VIDEO ON';

                // ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥Î•º Î©îÏù∏ ÌîåÎ†àÏù¥Ïñ¥ÏôÄ ÎèôÍ∏∞Ìôî
                if (ytPlayer && ytPlayerVisible) {
                    try {
                        const currentTime = ytPlayer.getCurrentTime();
                        const state = ytPlayer.getPlayerState();

                        ytPlayerVisible.seekTo(currentTime, true);

                        if (state === YT.PlayerState.PLAYING) {
                            ytPlayerVisible.playVideo();
                        } else {
                            ytPlayerVisible.pauseVideo();
                        }
                    } catch(e) {
                        console.error('Sync error:', e);
                    }
                }
            } else {
                videoContainer.classList.remove('visible');
                toggleBtn.classList.remove('active');
                toggleBtn.innerHTML = 'üì∫ VIDEO OFF';

                // ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥Îßå ÏùºÏãúÏ†ïÏßÄ (Î©îÏù∏ÏùÄ Í≥ÑÏÜç Ïû¨ÏÉù)
                if (ytPlayerVisible) {
                    try {
                        ytPlayerVisible.pauseVideo();
                    } catch(e) {}
                }
            }

            if (!isMuted) playBeep();
        }

        function onYoutubePlayerReady(event) {
            document.getElementById('ytAudioControls').classList.remove('hidden');
            
            // ÎπÑÎîîÏò§ Ï†úÎ™© Í∞ÄÏ†∏Ïò§Í∏∞ ÏãúÎèÑ
            try {
                const videoData = event.target.getVideoData();
                if (videoData && videoData.title) {
                    document.getElementById('ytVideoTitle').textContent = videoData.title;
                } else {
                    document.getElementById('ytVideoTitle').textContent = 'YouTube Audio Loaded';
                }
            } catch(e) {
                document.getElementById('ytVideoTitle').textContent = 'YouTube Audio Loaded';
            }
            
            updateYoutubeProgress();
        }

        function onYoutubePlayerStateChange(event) {
            const ytPlayBtn = document.getElementById('ytPlayBtn');

            try {
                if (event.data === YT.PlayerState.PLAYING) {
                    ytPlayBtn.innerHTML = '‚ùö‚ùö';
                    startYoutubeProgressUpdate();

                    // ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ ÎèôÍ∏∞Ìôî
                    if (isVideoVisible && ytPlayerVisible && ytPlayerVisible.getPlayerState) {
                        const currentTime = ytPlayer.getCurrentTime();
                        ytPlayerVisible.seekTo(currentTime, true);
                        ytPlayerVisible.playVideo();
                    }
                } else if (event.data === YT.PlayerState.PAUSED) {
                    ytPlayBtn.innerHTML = '‚ñ∂';
                    stopYoutubeProgressUpdate();

                    // ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ ÎèôÍ∏∞Ìôî
                    if (isVideoVisible && ytPlayerVisible && ytPlayerVisible.pauseVideo) {
                        ytPlayerVisible.pauseVideo();
                    }
                } else if (event.data === YT.PlayerState.ENDED) {
                    ytPlayBtn.innerHTML = '‚ñ∂';
                    stopYoutubeProgressUpdate();
                    // Î∞òÎ≥µ Ïû¨ÏÉù
                    ytPlayer.seekTo(0);
                    ytPlayer.playVideo();

                    // ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ÎèÑ Î∞òÎ≥µ
                    if (isVideoVisible && ytPlayerVisible) {
                        ytPlayerVisible.seekTo(0);
                        ytPlayerVisible.playVideo();
                    }
                }
            } catch(e) {
                console.error('YouTube state change error:', e);
            }
        }

        // ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ ÏÉÅÌÉú Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨ (ÏÇ¨Ïö©ÏûêÍ∞Ä ÎπÑÎîîÏò§ Ïª®Ìä∏Î°§ÏùÑ ÏßÅÏ†ë Ï°∞ÏûëÌï† Îïå)
        function onVisiblePlayerStateChange(event) {
            if (!isVideoVisible) return;

            try {
                // ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ÏóêÏÑú Ïû¨ÏÉù/ÏùºÏãúÏ†ïÏßÄÌïòÎ©¥ Î©îÏù∏ ÌîåÎ†àÏù¥Ïñ¥ÎèÑ ÎèôÍ∏∞Ìôî
                if (event.data === YT.PlayerState.PLAYING) {
                    if (ytPlayer && ytPlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
                        const currentTime = ytPlayerVisible.getCurrentTime();
                        ytPlayer.seekTo(currentTime, true);
                        ytPlayer.playVideo();
                    }
                } else if (event.data === YT.PlayerState.PAUSED) {
                    if (ytPlayer && ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                        ytPlayer.pauseVideo();
                    }
                }
            } catch(e) {
                console.error('Visible player state change error:', e);
            }
        }

        function toggleYoutubePlay() {
            if (!ytPlayer || !ytPlayer.getPlayerState) {
                alert('YouTube ÏòÅÏÉÅÏùÑ Î®ºÏ†Ä Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                const state = ytPlayer.getPlayerState();
                if (state === YT.PlayerState.PLAYING) {
                    ytPlayer.pauseVideo();
                } else {
                    ytPlayer.playVideo();
                }
            } catch(e) {
                console.error('YouTube player error:', e);
                alert('ÌîåÎ†àÏù¥Ïñ¥ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        function startYoutubeProgressUpdate() {
            if (ytUpdateInterval) {
                clearInterval(ytUpdateInterval);
            }
            ytUpdateInterval = setInterval(() => {
                updateYoutubeProgress();
                syncVideoPlayers(); // Ï£ºÍ∏∞Ï†Å ÎèôÍ∏∞Ìôî
            }, 500);
        }

        // Îëê ÌîåÎ†àÏù¥Ïñ¥ ÎèôÍ∏∞Ìôî Ï≤¥ÌÅ¨ (ÏãúÍ∞Ñ Ï∞®Ïù¥Í∞Ä 1Ï¥à Ïù¥ÏÉÅ ÎÇòÎ©¥ ÎèôÍ∏∞Ìôî)
        function syncVideoPlayers() {
            if (!isVideoVisible || !ytPlayer || !ytPlayerVisible) return;

            try {
                const mainTime = ytPlayer.getCurrentTime();
                const visibleTime = ytPlayerVisible.getCurrentTime();
                const timeDiff = Math.abs(mainTime - visibleTime);

                // 1Ï¥à Ïù¥ÏÉÅ Ï∞®Ïù¥ÎÇòÎ©¥ ÎèôÍ∏∞Ìôî
                if (timeDiff > 1) {
                    ytPlayerVisible.seekTo(mainTime, true);
                }
            } catch(e) {
                // Î¨¥Ïãú
            }
        }

        function stopYoutubeProgressUpdate() {
            if (ytUpdateInterval) {
                clearInterval(ytUpdateInterval);
            }
        }

        function updateYoutubeProgress() {
            if (!ytPlayer || !ytPlayer.getCurrentTime) return;
            
            try {
                const currentTime = ytPlayer.getCurrentTime();
                const duration = ytPlayer.getDuration();
                
                if (duration > 0) {
                    const progress = (currentTime / duration) * 100;
                    document.getElementById('ytProgressFill').style.width = progress + '%';
                    
                    const currentMin = Math.floor(currentTime / 60);
                    const currentSec = Math.floor(currentTime % 60);
                    const durationMin = Math.floor(duration / 60);
                    const durationSec = Math.floor(duration % 60);
                    
                    document.getElementById('ytTimeDisplay').textContent = 
                        `${currentMin}:${currentSec.toString().padStart(2, '0')} / ${durationMin}:${durationSec.toString().padStart(2, '0')}`;
                }
            } catch(e) {
                console.error('YouTube progress update error:', e);
            }
        }

        function seekYoutube(event) {
            if (!ytPlayer || !ytPlayer.getDuration) return;

            try {
                const bar = document.getElementById('ytProgressBar');
                const rect = bar.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const percentage = clickX / rect.width;
                const duration = ytPlayer.getDuration();
                const seekTime = duration * percentage;

                ytPlayer.seekTo(seekTime, true);

                // ÎπÑÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ÎèÑ ÎèôÍ∏∞Ìôî
                if (isVideoVisible && ytPlayerVisible && ytPlayerVisible.seekTo) {
                    ytPlayerVisible.seekTo(seekTime, true);
                }
            } catch(e) {
                console.error('YouTube seek error:', e);
            }
        }

        function playBeep() {
            if (isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); 
            oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        function playAlarm() {
            if (isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(523.25, now);
            oscillator.frequency.setValueAtTime(659.25, now + 0.2);
            oscillator.frequency.setValueAtTime(783.99, now + 0.4);
            oscillator.frequency.setValueAtTime(1046.50, now + 0.6);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.8);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start(now);
            oscillator.stop(now + 0.8);
        }

        function updateDisplay() {
            const m = Math.floor(remainingSeconds / 60);
            const s = remainingSeconds % 60;
            const timeText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
            display.textContent = timeText;
            
            // ÏßëÏ§ë Î™®Îìú ÌôîÎ©¥ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            const focusTimer = document.getElementById('focusTimer');
            if (focusTimer) {
                focusTimer.textContent = timeText;
            }
            
            const progress = totalSeconds > 0 ? ((totalSeconds - remainingSeconds) / totalSeconds) * 100 : 0;
            progressBar.style.width = `${progress}%`;
            
            if (remainingSeconds <= 10 && remainingSeconds > 0 && isRunning) {
                display.classList.add('text-red-500');
                display.classList.remove('text-amber-400');
                if (focusTimer) {
                    focusTimer.classList.add('text-red-500');
                    focusTimer.classList.remove('text-amber-400');
                }
            } else {
                display.classList.add('text-amber-400');
                display.classList.remove('text-red-500');
                if (focusTimer) {
                    focusTimer.classList.add('text-amber-400');
                    focusTimer.classList.remove('text-red-500');
                }
            }
        }

        function setPreset(minutes) {
            isPomodoroMode = false;
            stopTimer();
            totalSeconds = minutes * 60;
            remainingSeconds = totalSeconds;
            updateDisplay();
            statusText.textContent = `SET: ${minutes}M`;

            // ÏßëÏ§ë Î™®Îìú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            const focusStatus = document.getElementById('focusStatus');
            if (focusStatus) {
                focusStatus.textContent = `SET: ${minutes}M`;
            }

            modeDisplay.textContent = "MANUAL";
            recDot.classList.remove('bg-purple-500');
            recDot.classList.add('bg-red-500');
            if (!isMuted) playBeep();

            // Firebase ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            updateMyUserStatus();
        }

        function setCustom() {
            isPomodoroMode = false;
            const min = parseInt(document.getElementById('inputMin').value) || 0;
            const sec = parseInt(document.getElementById('inputSec').value) || 0;
            if (min === 0 && sec === 0) return;
            stopTimer();
            totalSeconds = min * 60 + sec;
            remainingSeconds = totalSeconds;
            updateDisplay();
            statusText.textContent = 'CUSTOM';
            
            const focusStatus = document.getElementById('focusStatus');
            if (focusStatus) {
                focusStatus.textContent = 'CUSTOM';
            }
            
            modeDisplay.textContent = "MANUAL";
            recDot.classList.remove('bg-purple-500');
            recDot.classList.add('bg-red-500');
            if (!isMuted) playBeep();
            document.getElementById('inputMin').value = '';
            document.getElementById('inputSec').value = '';
        }

        function startPomodoroSequence(workMinutes, breakMinutes) {
            stopTimer();
            isPomodoroMode = true;
            isWorkSession = true;
            currentWorkTime = workMinutes || 25;
            currentBreakTime = breakMinutes || 5;
            totalSeconds = currentWorkTime * 60; 
            remainingSeconds = totalSeconds;
            modeDisplay.textContent = `POMO ${currentWorkTime}/${currentBreakTime}`;
            statusText.textContent = `WORK (${currentWorkTime}M)`;
            
            const focusStatus = document.getElementById('focusStatus');
            if (focusStatus) {
                focusStatus.textContent = `WORK (${currentWorkTime}M)`;
            }
            
            recDot.classList.remove('bg-red-500');
            recDot.classList.add('bg-purple-500');
            updateDisplay();
            if (!isMuted) playBeep();
            startTimer(); 
        }

        function handlePomodoroTransition() {
            if (!isMuted) playAlarm();
            if (isWorkSession) {
                isWorkSession = false;
                totalSeconds = currentBreakTime * 60; 
                statusText.textContent = `BREAK (${currentBreakTime}M)`;
                
                const focusStatus = document.getElementById('focusStatus');
                if (focusStatus) {
                    focusStatus.textContent = `BREAK (${currentBreakTime}M)`;
                }
                
                display.classList.add('text-blue-400');
                display.classList.remove('text-amber-400', 'text-red-500');
            } else {
                isWorkSession = true;
                totalSeconds = currentWorkTime * 60; 
                statusText.textContent = `WORK (${currentWorkTime}M)`;
                
                const focusStatus = document.getElementById('focusStatus');
                if (focusStatus) {
                    focusStatus.textContent = `WORK (${currentWorkTime}M)`;
                }
                
                display.classList.add('text-amber-400');
                display.classList.remove('text-blue-400', 'text-red-500');
            }
            remainingSeconds = totalSeconds;
            progressBar.style.width = '0%';
            setTimeout(() => { startTimer(); }, 2000); 
        }

        function startTimer() {
            if (remainingSeconds <= 0) return;
            if (isRunning) return;
            isRunning = true;
            if (!isPomodoroMode) {
                statusText.textContent = 'RUNNING';
                const focusStatus = document.getElementById('focusStatus');
                if (focusStatus) {
                    focusStatus.textContent = 'RUNNING';
                }
            }
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            if (!isMuted) playBeep();

            // Firebase ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            updateMyUserStatus();

            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateDisplay();

                // Îß§Ï¥àÎßàÎã§ Firebase ÏóÖÎç∞Ïù¥Ìä∏ (ÎÑàÎ¨¥ ÏûêÏ£º ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏßÄ ÏïäÎèÑÎ°ù 3Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏)
                if (remainingSeconds % 3 === 0) {
                    updateMyUserStatus();
                }

                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    isRunning = false;

                    if (isPomodoroMode) {
                        handlePomodoroTransition();
                    } else {
                        statusText.textContent = 'DONE';

                        const focusStatus = document.getElementById('focusStatus');
                        if (focusStatus) {
                            focusStatus.textContent = 'DONE';
                        }

                        statusText.classList.add('animate-pulse');
                        startBtn.classList.remove('hidden');
                        stopBtn.classList.add('hidden');
                        if (!isMuted) playAlarm();
                        progressBar.style.width = '100%';

                        // Firebase ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                        updateMyUserStatus();
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            statusText.textContent = 'PAUSED';

            const focusStatus = document.getElementById('focusStatus');
            if (focusStatus) {
                focusStatus.textContent = 'PAUSED';
            }

            statusText.classList.remove('animate-pulse');
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');

            // Firebase ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            updateMyUserStatus();
        }

        function resetTimer() {
            stopTimer();
            isPomodoroMode = false;
            modeDisplay.textContent = "MANUAL";
            recDot.classList.remove('bg-purple-500');
            recDot.classList.add('bg-red-500');
            display.classList.remove('text-blue-400');
            display.classList.add('text-amber-400');

            const focusTimer = document.getElementById('focusTimer');
            if (focusTimer) {
                focusTimer.classList.remove('text-blue-400');
                focusTimer.classList.add('text-amber-400');
            }

            remainingSeconds = totalSeconds;
            updateDisplay();
            statusText.textContent = 'RESET';

            const focusStatus = document.getElementById('focusStatus');
            if (focusStatus) {
                focusStatus.textContent = 'RESET';
            }

            if (!isMuted) playBeep();

            // Firebase ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            updateMyUserStatus();
        }
    </script>
</body>
</html>
